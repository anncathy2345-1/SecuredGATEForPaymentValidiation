export default {
  async fetch(request, env) {
    const url = new URL(request.url);
    const token = url.searchParams.get("token");

    if (!token) {
      return new Response("Invalid request", { status: 400 });
    }

    const used = await env.TOKENS.get(token);

    if (used === "used") {
      return new Response("Token already used", { status: 403 });
    }

    if (!used) {
      return new Response("Invalid token", { status: 404 });
    }

    // mark as used
    await env.TOKENS.put(token, "used");

    return new Response(JSON.stringify({ ok: true }), {
      headers: { "Content-Type": "application/json" }
    });
  }
};
